language: c++
sudo: required
compiler:
  - gcc

git:
  # It takes a while to clone our submodules, so we'd like to use --jobs to
  # speed it up. Here we prevent travis from using git clone --recursive, so
  # below in before_install we can manually update including --jobs.
  submodules: false

before_install:
  # Unfortunately, the version of git we get by default is too low to support
  # --jobs on subdmodule, so update git before pulling in the submodules.
  - sudo add-apt-repository -y ppa:git-core/ppa
  - sudo apt-get update -q
  - sudo apt-get install -q -y git
  # git.apache.org is the canonical repo but throttles network connections.
  # using github.com seems to reduce network errors a lot.
  - git config --global url.https://github.com/apache/.insteadOf git://git.apache.org/
  - git submodule update --init
  - sudo apt-get install pkg-config zip g++ zlib1g-dev unzip python3
  - wget https://github.com/bazelbuild/bazel/releases/download/0.27.1/bazel-0.27.1-installer-linux-x86_64.sh
  - chmod +x bazel-0.27.1-installer-linux-x86_64.sh
  - ./bazel-0.27.1-installer-linux-x86_64.sh --user
env:
  global:
    - MAKEFLAGS=-j3
  matrix:
    - BIT_FLAG=
    # This would do another build for 32-bit, but we're already borderline
    # too slow on faster 64-bit, so skip this for now.
    # - BIT_FLAG=--32bit

script:
  # Travis will time out our build if doesn't output anything for > 10 mintes,
  # but --verbose sometimes outputs more than 4 MB of data, which will also
  # cause our build to be killed. travis_wait allows the command to be silent
  # for longer, but has the downside of not producing output if we timeout. See:
  # https://docs.travis-ci.com/user/common-build-problems/#Build-times-out-because-no-output-was-received
  # For now, stick with --verbose and keep an eye on the logs.
  - bazel build //:mod_pagespeed

notifications:
  email:
    - pagespeed-ci@googlegroups.com
