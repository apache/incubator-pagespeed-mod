load(
    "@envoy//bazel:envoy_build_system.bzl",
    "envoy_cc_library",
    "envoy_cc_test",
    "envoy_cc_test_library",
    "envoy_package",
)
load("//bazel:data2c.bzl", "data2c_gen2", "data2c_gen2_opt")

licenses(["notice"])  # Apache 2

envoy_package()

genrule(
    name = "csp_directive_gperf",
    srcs = ["csp_directive.gperf"],
    outs = ["csp_directive.gp.cc"],
    cmd = ("gperf -m10 $< > $@"),
)

genrule(
    name = "rewrite_filter_names_gperf",
    srcs = ["rewrite_filter_names.gperf"],
    outs = ["rewrite_filter_names.gp.cc"],
    cmd = ("gperf -m10 $< > $@"),
)

proto_library(
    name = "rewriter_protos",
    srcs = [
        "cached_result.proto",
        "critical_images.proto",
        "critical_keys.proto",
        "dependencies.proto",
        "flush_early.proto",
        "input_info.proto",
        "rendered_image.proto",
        "static_asset_config.proto",
    ],
    deps = [
        "//net/instaweb/spriter:spriter_protos",
        "//pagespeed/kernel/http:http_proto",
    ],
)

cc_proto_library(
    name = "rewriter_protos_cc",
    deps = [
        ":rewriter_protos",
    ],
)

data2c_gen2(
    name = "data2c_generated",
    srcs = [
        "add_instrumentation",
        "client_domain_rewriter",
        "critical_css_beacon",
        "critical_css_loader",
        "critical_images_beacon",
        "dedup_inlined_images",
        "defer_iframe",
        "delay_images",
        "delay_images_inline",
        "deterministic",
        "extended_instrumentation",
        "js_defer",
        "lazyload_images",
        "local_storage_cache",
        "responsive_js",
    ],
)

data2c_gen2_opt(
    name = "data2c_generated",
    srcs = [
        "add_instrumentation",
        "client_domain_rewriter",
        "critical_css_beacon",
        "critical_css_loader",
        "critical_images_beacon",
        "dedup_inlined_images",
        "defer_iframe",
        "delay_images",
        "delay_images_inline",
        "deterministic",
        "extended_instrumentation",
        "js_defer",
        "lazyload_images",
        "local_storage_cache",
        "responsive_js",
    ],
)

#"js_minify_main.cc",
#"css_minify_main.cc",

envoy_cc_library(
    name = "html_minifier_main_lib",
    srcs = [
        "html_minifier_main.cc"
    ],
    deps  = [
        ":rewriter"
    ],
    copts = [
        "-Wno-error=old-style-cast",
        "-Wno-error=unused-parameter",
        "-Wno-error=inconsistent-missing-override",
        "-Wno-missing-field-initializers",  # gperf
        "-Wno-error=unused-private-field",
        "-Wno-error=unused-variable",
        "-Ithird_party/css_parser/src/",
        "-Ithird_party/css_parser/src/third_party/utf",
    ],    
    repository = "@envoy",
    visibility = ["//visibility:public"],
)

envoy_cc_library(
    name = "rewriter",
    srcs = [
        "add_head_filter.cc",
        "add_ids_filter.cc",
        "add_instrumentation_filter.cc",
        "association_transformer.cc",
        "base_tag_filter.cc",
        "beacon_critical_images_finder.cc",
        "cache_extender.cc",
        "cacheable_resource_base.cc",
        "collect_dependencies_filter.cc",
        "common_filter.cc",
        "config/measurement_proxy_rewrite_options_manager.cc",
        "config/rewrite_options_manager.cc",
        "critical_css_beacon_filter.cc",
        "critical_finder_support_util.cc",
        "critical_images_beacon_filter.cc",
        "critical_images_finder.cc",
        "critical_selector_filter.cc",
        "critical_selector_finder.cc",
        "csp.cc",
        "css_absolutify.cc",
        "css_combine_filter.cc",
        "css_filter.cc",
        "css_hierarchy.cc",
        "css_image_rewriter.cc",
        "css_inline_filter.cc",
        "css_inline_import_to_link_filter.cc",
        "css_minify.cc",
        "css_move_to_head_filter.cc",
        "css_outline_filter.cc",
        "css_resource_slot.cc",
        "css_summarizer_base.cc",
        "css_tag_scanner.cc",
        "css_url_counter.cc",
        "css_url_encoder.cc",
        "css_url_extractor.cc",
        "css_util.cc",
        "data_url_input_resource.cc",
        "debug_filter.cc",
        "decode_rewritten_urls_filter.cc",
        "dedup_inlined_images_filter.cc",
        "defer_iframe_filter.cc",
        "delay_images_filter.cc",
        "dependency_tracker.cc",
        "deterministic_js_filter.cc",
        "device_properties.cc",
        "dom_stats_filter.cc",
        "domain_lawyer.cc",
        "domain_rewrite_filter.cc",
        "downstream_cache_purger.cc",
        "downstream_caching_directives.cc",
        "experiment_matcher.cc",
        "experiment_util.cc",
        "fake_filter.cc",
        "file_input_resource.cc",
        "file_load_mapping.cc",
        "file_load_policy.cc",
        "file_load_rule.cc",
        "fix_reflow_filter.cc",
        "flush_html_filter.cc",
        "google_analytics_filter.cc",
        "google_font_css_inline_filter.cc",
        "google_font_service_input_resource.cc",
        "handle_noscript_redirect_filter.cc",
        "image.cc",
        "image_combine_filter.cc",
        "image_rewrite_filter.cc",
        "image_url_encoder.cc",
        "in_place_rewrite_context.cc",
        "inline_attribute_slot.cc",
        "inline_output_resource.cc",
        "inline_resource_slot.cc",
        "inline_rewrite_context.cc",
        "input_info_utils.cc",
        "insert_amp_link_filter.cc",
        "insert_dns_prefetch_filter.cc",
        "insert_ga_filter.cc",
        "javascript_code_block.cc",
        "javascript_filter.cc",
        "javascript_library_identification.cc",
        "js_combine_filter.cc",
        "js_defer_disabled_filter.cc",
        "js_disable_filter.cc",
        "js_inline_filter.cc",
        "js_outline_filter.cc",
        "js_replacer.cc",
        "lazyload_images_filter.cc",
        "local_storage_cache_filter.cc",
        "make_show_ads_async_filter.cc",
        "measurement_proxy_url_namer.cc",
        "meta_tag_filter.cc",
        "output_resource.cc",
        "pedantic_filter.cc",
        "process_context.cc",
        "property_cache_util.cc",
        "push_preload_filter.cc",
        "redirect_on_size_limit_filter.cc",
        "request_properties.cc",
        "resource.cc",
        "resource_combiner.cc",
        "resource_fetch.cc",
        "resource_namer.cc",
        "resource_slot.cc",
        "resource_tag_scanner.cc",
        "responsive_image_filter.cc",
        "rewrite_context.cc",
        "rewrite_driver.cc",
        "rewrite_driver_factory.cc",
        "rewrite_driver_pool.cc",
        "rewrite_filter.cc",
        "rewrite_gflags.cc",
        "rewrite_options.cc",
        "rewrite_query.cc",
        "rewrite_stats.cc",
        "rewritten_content_scanning_filter.cc",
        "scan_filter.cc",
        "script_tag_scanner.cc",
        "server_context.cc",
        "simple_text_filter.cc",
        "single_rewrite_context.cc",
        "srcset_slot.cc",
        "static_asset_manager.cc",
        "strip_scripts_filter.cc",
        "strip_subresource_hints_filter.cc",
        "support_noscript_filter.cc",
        "url_input_resource.cc",
        "url_left_trim_filter.cc",
        "url_namer.cc",
        "url_partnership.cc",
        "usage_data_reporter.cc",
        "webp_optimizer.cc",
        ":csp_directive_gperf",
        ":data2c_generated_add_instrumentation",
        ":data2c_generated_add_instrumentation_opt",
        ":data2c_generated_client_domain_rewriter",
        ":data2c_generated_client_domain_rewriter_opt",
        ":data2c_generated_critical_css_beacon",
        ":data2c_generated_critical_css_beacon_opt",
        ":data2c_generated_critical_css_loader",
        ":data2c_generated_critical_css_loader_opt",
        ":data2c_generated_critical_images_beacon",
        ":data2c_generated_critical_images_beacon_opt",
        ":data2c_generated_dedup_inlined_images",
        ":data2c_generated_dedup_inlined_images_opt",
        ":data2c_generated_defer_iframe",
        ":data2c_generated_defer_iframe_opt",
        ":data2c_generated_delay_images",
        ":data2c_generated_delay_images_inline",
        ":data2c_generated_delay_images_inline_opt",
        ":data2c_generated_delay_images_opt",
        ":data2c_generated_deterministic",
        ":data2c_generated_deterministic_opt",
        ":data2c_generated_extended_instrumentation",
        ":data2c_generated_extended_instrumentation_opt",
        ":data2c_generated_js_defer",
        ":data2c_generated_js_defer_opt",
        ":data2c_generated_lazyload_images",
        ":data2c_generated_lazyload_images_opt",
        ":data2c_generated_local_storage_cache",
        ":data2c_generated_local_storage_cache_opt",
        ":data2c_generated_responsive_js",
        ":data2c_generated_responsive_js_opt",
        ":rewrite_filter_names_gperf",
    ],
    hdrs = [
        "config/measurement_proxy_rewrite_options_manager.h",
        "config/rewrite_options_manager.h",
        "google_analytics_snippet.h",
        "public/add_head_filter.h",
        "public/add_ids_filter.h",
        "public/add_instrumentation_filter.h",
        "public/association_transformer.h",
        "public/base_tag_filter.h",
        "public/beacon_critical_images_finder.h",
        "public/cache_extender.h",
        "public/cacheable_resource_base.h",
        "public/collect_dependencies_filter.h",
        "public/common_filter.h",
        "public/critical_css_beacon_filter.h",
        "public/critical_finder_support_util.h",
        "public/critical_images_beacon_filter.h",
        "public/critical_images_finder.h",
        "public/critical_selector_filter.h",
        "public/critical_selector_finder.h",
        "public/csp.h",
        "public/csp_directive.h",
        "public/css_absolutify.h",
        "public/css_combine_filter.h",
        "public/css_filter.h",
        "public/css_flatten_imports_context.h",
        "public/css_hierarchy.h",
        "public/css_image_rewriter.h",
        "public/css_inline_filter.h",
        "public/css_inline_import_to_link_filter.h",
        "public/css_minify.h",
        "public/css_move_to_head_filter.h",
        "public/css_outline_filter.h",
        "public/css_resource_slot.h",
        "public/css_summarizer_base.h",
        "public/css_tag_scanner.h",
        "public/css_url_counter.h",
        "public/css_url_encoder.h",
        "public/css_url_extractor.h",
        "public/css_util.h",
        "public/data_url_input_resource.h",
        "public/debug_filter.h",
        "public/decode_rewritten_urls_filter.h",
        "public/dedup_inlined_images_filter.h",
        "public/defer_iframe_filter.h",
        "public/delay_images_filter.h",
        "public/dependency_tracker.h",
        "public/deterministic_js_filter.h",
        "public/device_properties.h",
        "public/dom_stats_filter.h",
        "public/domain_lawyer.h",
        "public/domain_rewrite_filter.h",
        "public/downstream_cache_purger.h",
        "public/downstream_caching_directives.h",
        "public/experiment_matcher.h",
        "public/experiment_util.h",
        "public/fake_filter.h",
        "public/file_input_resource.h",
        "public/file_load_mapping.h",
        "public/file_load_policy.h",
        "public/file_load_rule.h",
        "public/fix_reflow_filter.h",
        "public/flush_html_filter.h",
        "public/google_analytics_filter.h",
        "public/google_font_css_inline_filter.h",
        "public/google_font_service_input_resource.h",
        "public/handle_noscript_redirect_filter.h",
        "public/image.h",
        "public/image_combine_filter.h",
        "public/image_data_lookup.h",
        "public/image_rewrite_filter.h",
        "public/image_url_encoder.h",
        "public/in_place_rewrite_context.h",
        "public/inline_attribute_slot.h",
        "public/inline_output_resource.h",
        "public/inline_resource_slot.h",
        "public/inline_rewrite_context.h",
        "public/input_info_utils.h",
        "public/insert_amp_link_filter.h",
        "public/insert_dns_prefetch_filter.h",
        "public/insert_ga_filter.h",
        "public/javascript_code_block.h",
        "public/javascript_filter.h",
        "public/javascript_library_identification.h",
        "public/js_combine_filter.h",
        "public/js_defer_disabled_filter.h",
        "public/js_disable_filter.h",
        "public/js_inline_filter.h",
        "public/js_outline_filter.h",
        "public/js_replacer.h",
        "public/lazyload_images_filter.h",
        "public/local_storage_cache_filter.h",
        "public/make_show_ads_async_filter.h",
        "public/measurement_proxy_url_namer.h",
        "public/meta_tag_filter.h",
        "public/output_resource.h",
        "public/output_resource_kind.h",
        "public/pedantic_filter.h",
        "public/process_context.h",
        "public/property_cache_util.h",
        "public/push_preload_filter.h",
        "public/redirect_on_size_limit_filter.h",
        "public/request_properties.h",
        "public/resource.h",
        "public/resource_combiner.h",
        "public/resource_fetch.h",
        "public/resource_namer.h",
        "public/resource_slot.h",
        "public/resource_tag_scanner.h",
        "public/responsive_image_filter.h",
        "public/rewrite_context.h",
        "public/rewrite_driver.h",
        "public/rewrite_driver_factory.h",
        "public/rewrite_driver_pool.h",
        "public/rewrite_filter.h",
        "public/rewrite_gflags.h",
        "public/rewrite_options.h",
        "public/rewrite_query.h",
        "public/rewrite_result.h",
        "public/rewrite_stats.h",
        "public/rewritten_content_scanning_filter.h",
        "public/scan_filter.h",
        "public/script_tag_scanner.h",
        "public/server_context.h",
        "public/simple_text_filter.h",
        "public/single_rewrite_context.h",
        "public/srcset_slot.h",
        "public/static_asset_manager.h",
        "public/strip_scripts_filter.h",
        "public/strip_subresource_hints_filter.h",
        "public/support_noscript_filter.h",
        "public/url_input_resource.h",
        "public/url_left_trim_filter.h",
        "public/url_namer.h",
        "public/url_partnership.h",
        "public/usage_data_reporter.h",
        "public/webp_optimizer.h",
    ],
    copts = [
        "-Wno-error=old-style-cast",
        "-Wno-error=unused-parameter",
        "-Wno-error=inconsistent-missing-override",
        "-Wno-missing-field-initializers",  # gperf
        "-Wno-error=unused-private-field",
        "-Wno-error=unused-variable",
        "-Ithird_party/css_parser/src/",
        "-Ithird_party/css_parser/src/third_party/utf",
    ],
    repository = "@envoy",
    visibility = ["//visibility:public"],
    deps = [
        ":rewriter_protos_cc",
        "//base",
        "//net/instaweb:net_instaweb_lib",
        #"//net/instaweb/config",
        "//net/instaweb/http",
        "//net/instaweb/spriter",
        "//net/instaweb/util",
        "//pagespeed/controller",
        "//pagespeed/kernel/base:pagespeed_base",
        "//pagespeed/kernel/cache",
        "//pagespeed/kernel/image",
        "//pagespeed/kernel/js",
        "//pagespeed/opt/ads",
        "//third_party/css_parser",
    ],
)

envoy_cc_test_library(
    name = "rewriter_test_base",
    srcs = [
        "critical_images_finder_test_base.cc",
        "css_rewrite_test_base.cc",
        "image_test_base.cc",
        "mock_critical_images_finder.cc",
        "mock_resource_callback.cc",
        "notifying_fetch.cc",
        "rewrite_context_test_base.cc",
        "rewrite_test_base.cc",
        "test_rewrite_driver_factory.cc",
        "test_url_namer.cc",
    ],
    hdrs = [
        "public/critical_images_finder_test_base.h",
        "public/css_rewrite_test_base.h",
        "public/image_test_base.h",
        "public/mock_critical_images_finder.h",
        "public/mock_resource_callback.h",
        "public/notifying_fetch.h",
        "public/rewrite_options_test_base.h",
        "public/rewrite_test_base.h",
        "public/test_rewrite_driver_factory.h",
        "public/test_url_namer.h",
        "public/rewrite_context_test_base.h",
        "public/custom_rewrite_test_base.h",
        "image_testing_peer.h",
    ],
    copts = [
        "-Wno-error=old-style-cast",
        "-Wno-error=unused-parameter",
        "-Wno-error=inconsistent-missing-override",
        "-Wno-error=unused-private-field",
        "-Wno-error=unused-variable",
    ],
    repository = "@envoy",
    deps = [
        ":rewriter",
        "//net/instaweb/http:http_test_base",
        "//pagespeed/kernel/http:http_test_base",
        "//pagespeed/kernel/cache:cache_test_base",
        "//pagespeed/kernel/html:html_test_base",
        "//pagespeed/kernel/thread:thread_test_base",
        "//pagespeed/kernel/util:util_test_base",
        "//pagespeed/kernel/image:image_test_base",
        "//pagespeed/opt/http:http_test_base",
        "//pagespeed/opt/logging:logging_test_base",
        "@glog",
    ],
)

envoy_cc_test(
    name = "rewriter_test",
    srcs = [
        "add_ids_filter_test.cc",
        "add_instrumentation_filter_test.cc",
        "association_transformer_test.cc",
        "base_tag_filter_test.cc",
        "beacon_critical_images_finder_test.cc",
        "cache_extender_test.cc",
        "cacheable_resource_base_test.cc",
        "collect_dependencies_filter_test.cc",
        "common_filter_test.cc",
#        "config/measurement_proxy_rewrite_options_manager_test.cc", pulls in pagespeed/automatic
        "config/rewrite_options_manager_test.cc",
        "critical_css_beacon_filter_test.cc",
        "critical_finder_support_util_test.cc",
        "critical_images_beacon_filter_test.cc",
        "critical_images_finder_test.cc",
        "critical_selector_filter_test.cc",
        "critical_selector_finder_test.cc",
        "csp_test.cc",
        "css_combine_filter_test.cc",
        "css_embedded_config_test.cc",
        "css_filter_test.cc",
        # XXX(oschaaf): css_flatten_imports_test dchecks, disable to get test ot continue running.
        # probably, I messed up the css parsing with some of the stuff involving CssStringPiece.
        "css_flatten_imports_test.cc",
        "css_hierarchy_test.cc",
        "css_image_rewriter_test.cc",
        "css_inline_filter_test.cc",
        "css_inline_import_to_link_filter_test.cc",
        #"css_minify_speed_test.cc",
        "css_minify_test.cc",
        "css_move_to_head_filter_test.cc",
        "css_outline_filter_test.cc",
        "css_summarizer_base_test.cc",
        "css_tag_scanner_test.cc",
        "css_url_encoder_test.cc",
        "css_util_test.cc",
        "debug_filter_test.cc",
        "decode_rewritten_urls_filter_test.cc",
        "dedup_inlined_images_filter_test.cc",
        "defer_iframe_filter_test.cc",
        "delay_images_filter_test.cc",
        "dependency_tracker_test.cc",
        "deterministic_js_filter_test.cc",
        "device_properties_test.cc",
        "dom_stats_filter_test.cc",
        #"domain_lawyer_speed_test.cc",
        "domain_lawyer_test.cc",
        "domain_rewrite_filter_test.cc",
        "downstream_cache_purger_test.cc",
        "downstream_caching_directives_test.cc",
        "experiment_matcher_test.cc",
        "experiment_util_test.cc",
        "file_load_policy_test.cc",
        "fix_reflow_filter_test.cc",
        "flush_html_filter_test.cc",
        "google_analytics_filter_test.cc",
        "google_font_css_inline_filter_test.cc",
        "google_font_service_input_resource_test.cc",
        "handle_noscript_redirect_filter_test.cc",
        "image_combine_filter_test.cc",
        "image_endian_test.cc",
        "image_rewrite_filter_test.cc",
        #"image_speed_test.cc",
        "image_test.cc",
        "image_url_encoder_test.cc",
        "in_place_rewrite_context_test.cc",
        "insert_amp_link_filter_test.cc",
        "insert_dns_prefetch_filter_test.cc",
        "insert_ga_filter_test.cc",
        "javascript_code_block_test.cc",
        "javascript_filter_test.cc",
        #"javascript_minify_speed_test.cc",
        "js_combine_filter_test.cc",
        "js_defer_disabled_filter_test.cc",
        "js_disable_filter_test.cc",
        "js_inline_filter_test.cc",
        "js_outline_filter_test.cc",
        "js_replacer_test.cc",
        "lazyload_images_filter_test.cc",
        "local_storage_cache_filter_test.cc",
        "make_show_ads_async_filter_test.cc",
        "measurement_proxy_url_namer_test.cc",
        "meta_tag_filter_test.cc",
        "pedantic_filter_test.cc",
        "property_cache_util_test.cc",
        "push_preload_filter_test.cc",
        "redirect_on_size_limit_filter_test.cc",
        "request_properties_test.cc",
        "resource_combiner_test.cc",
        "resource_fetch_test.cc",
        "resource_namer_test.cc",
        "resource_slot_test.cc",
        "resource_tag_scanner_test.cc",
        "resource_update_test.cc",
        "responsive_image_filter_test.cc",
        "rewrite_context_test.cc",
        #"rewrite_driver_speed_test.cc",
        "rewrite_driver_test.cc",
        "rewrite_options_test.cc",
        "rewrite_query_test.cc",
        "rewrite_single_resource_filter_test.cc",
        "rewriter_test.cc",
        "rewritten_content_scanning_filter_test.cc",
        "scan_filter_test.cc",
        "script_tag_scanner_test.cc",
        "server_context_test.cc",
        "shared_cache_test.cc",
        "srcset_slot_test.cc",
        "static_asserts_test.cc",
        "static_asset_manager_test.cc",
        "strip_scripts_filter_test.cc",
        "strip_subresource_hints_filter_test.cc",
        "support_noscript_filter_test.cc",
        "two_level_cache_test.cc",
        "url_input_resource_test.cc",
        "url_left_trim_filter_test.cc",
        "url_namer_test.cc",
        "url_partnership_test.cc",
        "webp_optimizer_test.cc",
    ],
    copts = [
        "-Wno-error=old-style-cast",
        "-Wno-error=unused-parameter",
        "-Wno-error=unused-function",
        "-Wno-error=sign-compare",
        "-Wno-error=inconsistent-missing-override",
        "-Wno-missing-field-initializers",  # gperf
        "-Wno-error=unused-private-field",
        "-Wno-error=unused-variable",
        "-Ithird_party/css_parser/src/",
        "-Ithird_party/css_parser/src/third_party/utf",
    ],
    data = glob(["testdata/*"]),
    repository = "@envoy",
    deps = [
        ":rewriter_test_base",
    ],
)
