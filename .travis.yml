language: c++
compiler:
  - clang
dist: bionic
git:
  # Dependencies will be fetched via bazel. So no submodules here.
  submodules: false
  depth: 10

before_install:
  - sudo add-apt-repository -y ppa:git-core/ppa
  - sudo apt-get update -q
  - sudo apt-get install -q -y git
  - sudo apt-get install pkg-config zip g++ zlib1g-dev unzip python3 ninja-build cmake gperf memcached
  - wget https://github.com/bazelbuild/bazel/releases/download/0.28.1/bazel-0.28.1-installer-linux-x86_64.sh
  - chmod +x bazel-0.28.1-installer-linux-x86_64.sh
  - ./bazel-0.28.1-installer-linux-x86_64.sh --user
env:
  global:
    - MAKEFLAGS=-j3
  matrix:
    - BIT_FLAG=
    # This would do another build for 32-bit, but we're already borderline
    # too slow on faster 64-bit, so skip this for now.
    # - BIT_FLAG=--32bit

script:
  # Travis will time out our build if doesn't output anything for > 10 mintes,
  # but --verbose sometimes outputs more than 4 MB of data, which will also
  # cause our build to be killed. travis_wait allows the command to be silent
  # for longer, but has the downside of not producing output if we timeout. See:
  # https://docs.travis-ci.com/user/common-build-problems/#Build-times-out-because-no-output-was-received
  # For now, stick with --verbose and keep an eye on the logs.
  # - bazel build --jobs=3 -c dbg //:mod_pagespeed
  - bazel test --jobs=3 -c dbg //pagespeed/...

notifications:
  email:
    - pagespeed-ci@googlegroups.com
